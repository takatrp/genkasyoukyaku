<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>減価償却費 試算ツール</title>
<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
<style>
  :root{ --bg:#f7f8fa; --card:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --accent:#578899; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.04);padding:14px 14px 10px;border:1px solid var(--line)}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{height:48px;width:auto;object-fit:contain}
  h1{font-size:22px;margin:0;letter-spacing:.2px}
  .chips{display:flex;gap:6px;align-items:center;margin-top:4px}
  .tag{display:inline-block;font-size:11px;background:#eef6fa;color:#195067;border:1px solid #d7e6ee;border-radius:999px;padding:2px 8px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;box-sizing:border-box;padding:12px 11px;border-radius:12px;border:1px solid var(--line);font-size:16px;background:#fff}
  input:focus,select:focus{outline:2px solid rgba(87,136,153,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .note{font-size:12px;color:var(--muted);line-height:1.5}
  .btn{background:var(--accent);color:#fff;border:none;font-weight:600}
  .btn:active{transform:translateY(1px)}
  table{border-collapse:collapse;width:100%;font-size:13px;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:right}
  th{position:sticky;top:0;background:#f0f5f7;color:#0b2230;text-align:right}
  th:first-child,td:first-child{text-align:left}
  .scroll-x{overflow-x:auto;border-radius:12px;border:1px solid var(--line)}
  footer.site{font-size:11px;color:var(--muted);margin-top:14px;text-align:center}
  a.footlink{color:inherit !important;text-decoration:underline}
  .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:8px 10px;border-radius:10px;font-size:12px}
  .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:8px 10px;border-radius:10px;font-size:12px}
  @media print{
    body{background:#fff}
    .no-print{display:none !important}
    .card{box-shadow:none;border:0}
    .scroll-x{overflow:visible;border:0}
    th{position:static}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <img class="logo" src="ロゴ.jpg" alt="税理士法人松本会計事務所 ロゴ"/>
        <div>
          <h1>減価償却費 試算ツール</h1>
          <div class="chips">
            <span class="tag">率表内蔵</span>
            <span class="tag">プリセット</span>
          </div>
        </div>
      </div>
      <div class="grid">
        <div>
          <label>資産タイプ（主要科目プリセット）</label>
          <select id="assetType"></select>
        </div>
        <div>
          <label>取得価額（円）</label>
          <input id="price" inputmode="numeric" placeholder="例）1,200,000" />
        </div>
        <div>
          <label>耐用年数（年）</label>
          <input id="life" type="number" min="1" step="1" placeholder="例）5" />
        </div>
        <div>
          <label>償却方法</label>
          <select id="method">
            <option value="sl">定額法</option>
            <option value="db200">定率法（200%・保証額/改定率スイッチ）</option>
            <option value="ikkatsu">一括償却（20万円未満/3年均等）</option>
            <option value="sme300">少額（30万円未満）特例：即時償却（中小企業者等のみ）</option>
            <option value="lt100">10万円未満：即時償却（全事業者）</option>
          </select>
        </div>
        <div>
          <label>事業の用に供した日</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label>決算月（期末は毎年「月末」）</label>
          <select id="fye"></select>
        </div>
        <div>
          <label>中小企業者等の30万円特例「当期の残枠」（円）<span style="color:#64748b">※該当時のみ</span></label>
          <input id="smeCap" inputmode="numeric" placeholder="例）3,000,000（初期値）" />
        </div>
        <div>
          <label>中古（簡便法）</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="usedFlag" type="checkbox" />
            <span class="note">適用する（建物等は個別見積りが原則。簡便法は資本的支出50％超の場合は不可）</span>
          </div>
        </div>
        <div>
          <label>初度・製造年月（任意／<code>YYYY-MM</code>）</label>
          <input id="firstUseMonth" type="month" />
        </div>
        <div>
          <label>経過年数（年）※未入力なら上記から自動算定</label>
          <input id="elapsedYears" type="number" min="0" step="0.1" placeholder="例）3" />
        </div>
        <div>
          <label>取得後に使用のための資本的支出が取得価額の50％超</label>
          <div><input id="capOver50" type="checkbox" /> <span class="note">※チェック時は簡便法を使えません</span></div>
        </div>
      </div>
      <div class="row no-print" style="margin-top:8px">
        <button class="btn" id="run">計算する</button>
        <button id="csvBtn">CSVダウンロード</button>
        <button id="printBtn">印刷</button>
      </div>
      <div id="msg" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">計算結果</div>
      <div id="summary" class="ok" style="display:none"></div>
      <div class="scroll-x" style="margin-top:10px">
        <table id="tbl" aria-label="償却スケジュール">
          <thead>
            <tr>
              <th>期</th>
              <th>期首帳簿価額</th>
              <th>償却費</th>
              <th>月割係数</th>
              <th>累計償却額</th>
              <th>期末帳簿価額</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <footer>
        <div class="note">
          ・定率法（200%）は<strong>償却率・改定償却率・保証率</strong>を表に基づき適用し、保証額未達期から改定取得価額×改定償却率で<strong>毎年同額</strong>に切替。<br/>
          ・期末は各年の決算月末。初年度は使用月数/12で按分（いわゆる月割）。最終年は<strong>1円残し</strong>で調整。<br/>
          ・中古（簡便法）は、<strong>法定耐用年数と経過年数</strong>から見積耐用年数を算定（端数切捨て・<strong>最低2年</strong>）。<br/>
          ・プリセット耐用年数は代表例。正式な年数は国税庁「主な耐用年数表」および「中古資産の耐用年数（No.5404）」をご確認ください。
        </div>
      </footer>
    </div>

    <footer class="site">
      Copyright (c) 2025 <a class="footlink" href="https://www.matsumoto-kaikei.or.jp/">税理士法人松本会計事務所</a> All Rights Reserved. / r◯
    </footer>
  </div>

<script>
// ===== 国税庁「償却率等表（200%定率）」の内蔵値 =====
const RATE200 = {
  2:{rate:1.000,revised:1.000,guarantee:0.00000},
  3:{rate:0.667,revised:1.000,guarantee:0.11089},
  4:{rate:0.500,revised:1.000,guarantee:0.12499},
  5:{rate:0.400,revised:0.500,guarantee:0.10800},
  6:{rate:0.333,revised:0.334,guarantee:0.09911},
  7:{rate:0.286,revised:0.334,guarantee:0.08680},
  8:{rate:0.250,revised:0.334,guarantee:0.07909},
  9:{rate:0.222,revised:0.250,guarantee:0.07126},
 10:{rate:0.200,revised:0.250,guarantee:0.06552},
 11:{rate:0.182,revised:0.200,guarantee:0.05992},
 12:{rate:0.167,revised:0.200,guarantee:0.05566},
 13:{rate:0.154,revised:0.167,guarantee:0.05180},
 14:{rate:0.143,revised:0.167,guarantee:0.04854},
 15:{rate:0.133,revised:0.143,guarantee:0.04565},
 16:{rate:0.125,revised:0.143,guarantee:0.04294},
 17:{rate:0.118,revised:0.125,guarantee:0.04038},
 18:{rate:0.111,revised:0.112,guarantee:0.03884},
 19:{rate:0.105,revised:0.112,guarantee:0.03693},
 20:{rate:0.100,revised:0.112,guarantee:0.03486},
 21:{rate:0.095,revised:0.100,guarantee:0.03335},
 22:{rate:0.091,revised:0.100,guarantee:0.03182},
 23:{rate:0.087,revised:0.091,guarantee:0.03052},
 24:{rate:0.083,revised:0.084,guarantee:0.02969},
 25:{rate:0.080,revised:0.084,guarantee:0.02841},
 26:{rate:0.077,revised:0.084,guarantee:0.02716},
 27:{rate:0.074,revised:0.077,guarantee:0.02624},
 28:{rate:0.071,revised:0.072,guarantee:0.02568},
 29:{rate:0.069,revised:0.072,guarantee:0.02463},
 30:{rate:0.067,revised:0.072,guarantee:0.02366},
 31:{rate:0.065,revised:0.067,guarantee:0.02286},
 32:{rate:0.063,revised:0.067,guarantee:0.02216},
 33:{rate:0.061,revised:0.063,guarantee:0.02161},
 34:{rate:0.059,revised:0.063,guarantee:0.02097},
 35:{rate:0.057,revised:0.059,guarantee:0.02051},
 36:{rate:0.056,revised:0.059,guarantee:0.01974},
 37:{rate:0.054,revised:0.056,guarantee:0.01950},
 38:{rate:0.053,revised:0.056,guarantee:0.01882},
 39:{rate:0.051,revised:0.053,guarantee:0.01860},
 40:{rate:0.050,revised:0.053,guarantee:0.01791},
 41:{rate:0.049,revised:0.050,guarantee:0.01741},
 42:{rate:0.048,revised:0.050,guarantee:0.01694},
 43:{rate:0.047,revised:0.048,guarantee:0.01664},
 44:{rate:0.045,revised:0.046,guarantee:0.01664},
 45:{rate:0.044,revised:0.046,guarantee:0.01634},
 46:{rate:0.043,revised:0.044,guarantee:0.01601},
 47:{rate:0.043,revised:0.044,guarantee:0.01532},
 48:{rate:0.042,revised:0.044,guarantee:0.01499},
 49:{rate:0.041,revised:0.042,guarantee:0.01475},
 50:{rate:0.040,revised:0.042,guarantee:0.01440},
 51:{rate:0.040,revised:0.050,guarantee:0.01053},
 52:{rate:0.040,revised:0.050,guarantee:0.01036},
 53:{rate:0.039,revised:0.048,guarantee:0.01028},
 54:{rate:0.039,revised:0.048,guarantee:0.01015},
 55:{rate:0.039,revised:0.046,guarantee:0.01007},
 56:{rate:0.038,revised:0.046,guarantee:0.00961},
 57:{rate:0.038,revised:0.046,guarantee:0.00952},
 58:{rate:0.038,revised:0.044,guarantee:0.00945},
 59:{rate:0.037,revised:0.044,guarantee:0.00934},
 60:{rate:0.037,revised:0.044,guarantee:0.00895}
};

// 主要耐用年数プリセット（代表例）
const ASSET_TYPES = [
  {label:'（直接入力）', life:null},
  {label:'パソコン（電子計算機・PC）', life:4},
  {label:'サーバ（電子計算機のうち）', life:5},
  {label:'複合機・プリンタ（事務用機器）', life:5},
  {label:'工具・器具備品（一般）', life:5},
  {label:'普通乗用車（一般）', life:6},
  {label:'軽自動車等', life:4},
  {label:'トラック（小型）', life:5},
  {label:'事務机・椅子等（什器備品）', life:8},
  {label:'建物附属設備（事務所等）', life:15},
  {label:'ソフトウェア（自社利用）', life:5}
];

// -------- utils ---------
const fmtYen = n => new Intl.NumberFormat('ja-JP',{maximumFractionDigits:0}).format(Math.round(n||0));
const ceil3 = x => Math.ceil(x*1000)/1000; // 定額法の率：第3位切上げ
const slRate = life => (life===3 ? 0.334 : ceil3(1/Math.max(1, life)));
const parseYen = v => { if(v==null) return NaN; const s=String(v); let out=''; for(let i=0;i<s.length;i++){ const c=s[i]; if((c>='0'&&c<='9')||c==='.'||c==='-'){ out+=c; } } return out.trim()===''?NaN:Number(out); };
function monthsInUse(start, fyeMonth){
  if(!(start instanceof Date) || isNaN(start)){return 12}
  const y = start.getFullYear();
  let fyEndYear = start.getMonth()+1 <= fyeMonth ? y : y+1;
  let months = (fyEndYear - y)*12 + (fyeMonth - (start.getMonth()+1)) + 1;
  return Math.max(0, Math.min(12, months));
}

// ===== 中古資産（簡便法）ユーティリティ =====
function yearsFloorDiffByMonth(firstUseMonthStr, startDate){
  if(!firstUseMonthStr || !startDate) return NaN;
  const [yy,mm] = firstUseMonthStr.split('-').map(Number);
  if(!yy||!mm) return NaN;
  const a = new Date(yy, mm-1, 1);
  const b = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
  const months = (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth());
  return Math.floor(Math.max(0, months)/12);
}
function usedLifeSimplified(baseLife, elapsedYears){
  const N = Math.max(1, baseLife|0);
  const E = Math.max(0, Math.floor(elapsedYears)); // 1年未満切捨て
  let L = 0;
  if(E >= N){
    L = Math.floor(N * 0.2);
  }else{
    L = Math.floor((N - E) + E * 0.2);
  }
  if(L < 2) L = 2; // 最低2年
  return L;
}

function buildSchedule({price, life, method, startDate, fyeMonth, smeCap}){
  const rows=[];
  const firstMonths = monthsInUse(startDate, fyeMonth);

  // 即時償却（10万円未満）
  if(method==='lt100' && price<100000){
    rows.push({period:1, open:price, dep:price, months:`${firstMonths}/12`, acc:price, close:1, memo:'10万円未満 即時償却'});
    return rows;
  }

  // 30万円特例（中小企業者等）
  if(method==='sme300' && price<300000){
    const use = Math.min(price, Math.max(0, smeCap||3000000));
    const rem = price - use;
    rows.push({period:1, open:price, dep:use, months:'—', acc:use, close:Math.max(1, price-use), memo:'30万円特例（中小企業者等）即時償却'});
    if(rem<=0){ rows[0].close = 1; return rows; }
    method='sl'; price = rem; // 残額は定額法
  }

  // 一括償却（20万円未満/3年均等）
  if(method==='ikkatsu'){
    const split = price/3;
    const years = 3; let acc=0; let open=price; let close=price;
    for(let k=1;k<=years;k++){
      const months = (k===1? firstMonths:12)+"/12";
      const dep = split * (k===1? firstMonths/12 : 1);
      acc += dep; close -= dep; if(close<1) close=1;
      rows.push({period:k, open:open, dep, months, acc, close, memo:'一括償却（均等）'});
      open = close;
    }
    return rows;
  }

  // 通常（定額 or 200%定率）
  const years = Math.max(1, life|0);
  let open = price; let acc=0;

  if(method==='sl'){
    const rate = slRate(years);
    for(let k=1;k<=years;k++){
      const months = (k===1? firstMonths:12);
      let dep = price*rate*(months/12);
      if(k===years){ dep = Math.max(0, open - 1); } // 最終調整：1円残し
      acc += dep; let close = open - dep; if(close<1) close=1;
      rows.push({period:k, open, dep, months:months+"/12", acc, close, memo:`定額法（率:${rate.toFixed(3)}）`});
      open = close;
      if(close<=1.0) break;
    }
    return rows;
  }

  if(method==='db200'){
    const rInfo = RATE200[years] || {rate: 2/years, revised: 1/Math.max(1,years), guarantee: 0};
    const rate = rInfo.rate; const gRate = rInfo.guarantee; const fixRate = rInfo.revised;
    let switched=false; let revisedBase=null;
    for(let k=1;k<=years;k++){
      const months = (k===1? firstMonths:12);
      if(!switched){
        const dbAmt = open * rate * (months/12);
        const gAmt  = price * gRate * (months/12);
        if(dbAmt < gAmt){ switched = true; revisedBase = open; }
      }
      let dep=0; let memo='';
      if(switched){ dep = revisedBase * fixRate * (months/12); memo = '改定償却率（毎年同額）'; }
      else{ dep = open * rate * (months/12); memo = '定率法（200%）'; }
      if(k===years){ dep = Math.min(dep, Math.max(0, open - 1)); memo += '（最終調整）'; }
      const close = Math.max(1, open - dep);
      const accPrev = rows.length? rows[rows.length-1].acc : 0;
      acc = accPrev + dep;
      rows.push({period:k, open, dep, months:months+"/12", acc, close, memo});
      open = close;
      if(close<=1) break;
    }
    return rows;
  }

  return rows;
}

function toCSV(rows){
  const header = ['期','期首帳簿価額','償却費','月割係数','累計償却額','期末帳簿価額','備考'];
  const lines = [header.join(',')];
  rows.forEach(r=>{ lines.push([r.period, Math.round(r.open), Math.round(r.dep), r.months, Math.round(r.acc), Math.round(r.close), r.memo].join(',')); });
  return new Blob(["\uFEFF"+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
}

function render(rows){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  let firstDep = rows[0]?.dep||0;
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="text-align:left">${r.period}</td>
      <td>¥${fmtYen(r.open)}</td>
      <td><strong>¥${fmtYen(r.dep)}</strong></td>
      <td>${r.months}</td>
      <td>¥${fmtYen(r.acc)}</td>
      <td>¥${fmtYen(r.close)}</td>
      <td style="text-align:left;color:#334155">${r.memo||''}</td>`;
    tbody.appendChild(tr);
  });
  const sum = rows.reduce((s,r)=>s+r.dep,0);
  const box=document.getElementById('summary');
  box.textContent=`初年度償却費：¥${fmtYen(firstDep)} ／ 総償却費：¥${fmtYen(sum)}（端数調整後）`;
  box.style.display='block';
}

function go(){
  const price = parseYen(document.getElementById('price').value);
  const baseLife  = Number(document.getElementById('life').value);
  const method= document.getElementById('method').value;
  const smeCap= parseYen(document.getElementById('smeCap').value || '3000000');
  const fyeMonth= Number(document.getElementById('fye').value);
  const sdRaw = document.getElementById('startDate').value;
  const startDate = sdRaw? new Date(sdRaw+'T00:00:00') : null;
  const usedFlag = document.getElementById('usedFlag').checked;
  const capOver50 = document.getElementById('capOver50').checked;
  const elapsedInput = Number(document.getElementById('elapsedYears').value);
  const firstUseMonth = document.getElementById('firstUseMonth').value;

  const msg = document.getElementById('msg');
  msg.innerHTML='';
  if(!price||isNaN(price)||price<=0){ msg.innerHTML='<div class="warn">取得価額を入力してください。</div>'; return; }
  if(['sl','db200'].includes(method) && (!baseLife||isNaN(baseLife)||baseLife<=0)){
    msg.innerHTML='<div class="warn">耐用年数（年）を入力してください。</div>'; return;
  }
  if(!startDate){ msg.innerHTML='<div class="warn">「事業の用に供した日」を入力してください（初年度の月割に使用します）。</div>'; return; }

  let effectiveLife = baseLife; let usedNote='';
  if(usedFlag){
    if(capOver50){
      msg.innerHTML='<div class="warn">取得後に使用のための資本的支出が取得価額の50％超の場合、簡便法は適用できません（基準耐用年数で計算）。</div>';
    }else{
      let E = !isNaN(elapsedInput) && elapsedInput>0 ? Math.floor(elapsedInput) : yearsFloorDiffByMonth(firstUseMonth, startDate);
      if(isNaN(E)){
        msg.innerHTML='<div class="warn">中古（簡便法）を適用する場合は、「経過年数」または「初度・製造年月」を入力してください。</div>';
        return;
      }
      effectiveLife = usedLifeSimplified(baseLife, E);
      usedNote = `中古（簡便法）: 元${baseLife}年・経過${E}年 → 見積耐用年数 ${effectiveLife}年`;
    }
  }

  const rows = buildSchedule({price, life:effectiveLife, method, startDate, fyeMonth, smeCap});
  render(rows);

  if(usedNote){
    const box=document.getElementById('summary');
    box.textContent = box.textContent + ' ／ ' + usedNote;
  }

  const blob = toCSV(rows);
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='depreciation_schedule.csv';
  document.getElementById('csvBtn').onclick=()=>a.click();
}

document.getElementById('run').addEventListener('click', go);

document.getElementById('printBtn').addEventListener('click', ()=> window.print());

['price','smeCap'].forEach(id=>{
  const el=document.getElementById(id);
  const formatNow=()=>{ const n=parseYen(el.value); if(!isNaN(n)){ el.value=fmtYen(n); try{ el.setSelectionRange(el.value.length, el.value.length);}catch(_){} } };
  el.addEventListener('input', formatNow);
  el.addEventListener('blur', formatNow);
});

(function init(){
  const fyeSel=document.getElementById('fye');
  for(let m=1;m<=12;m++){
    const op=document.createElement('option'); op.value=m; op.textContent=m+'月'; if(m===3) op.selected=true; fyeSel.appendChild(op);
  }
  const atSel=document.getElementById('assetType');
  ASSET_TYPES.forEach((x,i)=>{ const op=document.createElement('option'); op.value=i; op.textContent=x.label + (x.life?`（${x.life}年）`:'' ); atSel.appendChild(op); });
  atSel.addEventListener('change',()=>{ const v=ASSET_TYPES[Number(atSel.value)]; if(v&&v.life){ document.getElementById('life').value=v.life; }});
})();

// ========= 追加の自己テスト（コンソールのみ・既存テストは改変しない方針） =========
(function selfTest(){
  try{
    // 1) グローバルに rows を露出していないこと（誤ったトップレベル実行の検知）
    if(typeof window.rows !== 'undefined') console.warn('SelfTest: unexpected global "rows" found');

    // 2) usedLifeSimplified の代表例
    if(usedLifeSimplified(6,3)!==3) console.warn('SelfTest: used N6/E3 expected 3');
    if(usedLifeSimplified(6,7)!==2) console.warn('SelfTest: used N6/E7 expected 2');

    // 3) 年数換算（端数切捨て）
    const e = yearsFloorDiffByMonth('2022-10', new Date('2025-04-01'));
    if(e!==2) console.warn('SelfTest: yearsFloorDiff expected 2, got', e);

    // 4) CSV Blob生成
    const b = toCSV([{period:1,open:100,dep:100,months:'12/12',acc:100,close:1,memo:'t'}]);
    if(!(b && b.size>0)) console.warn('SelfTest: CSV blob NG');
  }catch(err){ console.error('SelfTest exception', err); }
})();
</script>
</body>
</html>
