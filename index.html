
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>減価償却費 試算ツール</title>
<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
<style>
  :root{ --bg:#f7f8fa; --card:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --accent:#578899; --bar1:#bcd7ea; --bar2:#f7c8c8; --lineStrong:#195067; --chipOnBg:#e6f0f4; --chipOnBd:#cfe0e6; --chipOnInk:#174a5a; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:900px;margin:0 auto;padding:12px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.04);padding:14px 14px 10px;border:1px solid var(--line)}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{height:48px;width:auto;object-fit:contain}
  h1{font-size:26px;margin:0;letter-spacing:.2px}
  .chips{display:flex;gap:6px;align-items:center;margin-top:4px}
  .tag{display:inline-block;font-size:11px;background:#eef6fa;color:#195067;border:1px solid #d7e6ee;border-radius:999px;padding:2px 8px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button{width:100%;box-sizing:border-box;padding:12px 11px;border-radius:12px;border:1px solid var(--line);font-size:16px;background:#fff}
  input:focus,select:focus{outline:2px solid rgba(87,136,153,.25)}
  input::placeholder{color:#a3acb8;opacity:1}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .note{font-size:12px;color:var(--muted);line-height:1.5}
  .small{font-size:11px}
  .btn{background:var(--accent);color:#fff;border:none;font-weight:600;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  table{border-collapse:collapse;width:100%;font-size:13px;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:right}
  th{position:sticky;top:0;background:#f0f5f7;color:#0b2230;text-align:right;font-size:12px;white-space:nowrap}
  th:first-child,td:first-child{text-align:left}
  .scroll-x{overflow-x:auto;border-radius:12px;border:1px solid var(--line)}
  .chart-wrap{position:relative;height:280px}
  canvas#chart{width:100%;height:100%;display:block}
  .legend{position:absolute;right:8px;top:6px;background:#ffffffcc;border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:11px;color:#334155}
  .legend-item{display:flex;align-items:center;gap:6px;margin:3px 0}
  .swatch{width:10px;height:10px;border-radius:3px;border:1px solid #94a3b8}
  footer.site{font-size:11px;color:var(--muted);margin-top:14px;text-align:center}
  a.footlink{color:inherit !important;text-decoration:underline}
  .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:8px 10px;border-radius:10px;font-size:12px}
  .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:8px 10px;border-radius:10px;font-size:12px}
  @media print{ body{background:#fff} .no-print{display:none !important} .card{box-shadow:none;border:0} .scroll-x{overflow:visible;border:0} th{position:static} }
  /* chips */
  .chipbar{display:flex;gap:6px;align-items:center;flex-wrap:nowrap}
  .chip{border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px;background:#fff;cursor:pointer;user-select:none;white-space:nowrap}
  .chip-on{background:var(--chipOnBg);border-color:var(--chipOnBd);color:var(--chipOnInk)}
  .chip-disabled{opacity:.5;pointer-events:none}
  /* small life & m1 input */
  #life{max-width:110px;padding:8px 10px;font-size:15px}
  #m1{max-width:110px;padding:8px 10px;font-size:15px;background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener"><img class="logo" src="ロゴ.jpg" alt="税理士法人松本会計事務所 ロゴ"/></a>
        <div>
          <h1>減価償却費 試算ツール</h1>
          <div class="chips">
            <span class="tag">率表内蔵</span>
            <span class="tag">プリセット</span>
          </div>
        </div>
      </div>
      
      <!-- 入力フロー：資産タイプ → 新規/中古 → 取得価額 → 耐用年数 → 償却方法 → 初年度月数 → 端数処理 -->
      <div class="grid">
        <div>
          <label>資産タイプ（主要科目プリセット）</label>
          <select id="assetType"></select>
        </div>
        <div>
          <label>新規／中古（簡便法）</label>
          <div id="usedChips" class="chipbar">
            <button type="button" class="chip chip-on" data-val="new">新規取得</button>
            <button type="button" class="chip" data-val="used">中古取得（簡便法）</button>
          </div>
        </div>
        <div>
          <label>取得価額（円）</label>
          <input id="price" inputmode="numeric" placeholder="例）1,200,000" />
        </div>
        <div>
          <label>耐用年数（年）</label>
          <input id="life" type="number" min="1" step="1" placeholder="例）5" />
          <div id="rateInfo" class="note small"></div>
        </div>
        <div>
          <label>償却方法</label>
          <div class="chipbar" id="methodChips">
            <button type="button" class="chip" data-val="sl">定額法</button>
            <button type="button" class="chip" data-val="db200">定率法</button>
          </div>
          <select id="method" aria-hidden="true" style="display:none">
            <option value="sl">定額法</option>
            <option value="db200">定率法</option>
          </select>
        </div>
        <div>
          <label>初年度月数</label>
          <input id="m1" type="number" min="1" max="12" step="1" placeholder="1〜12" / value="12">
        </div>
        <div>
          <label>端数処理（表示額）</label>
          <div id="roundingChips" class="chipbar">
            <button type="button" class="chip chip-on" data-val="floor">切捨て</button>
            <button type="button" class="chip" data-val="ceil">切上げ</button>
            <button type="button" class="chip" data-val="round">四捨五入</button>
          </div>
        </div>
      </div>

      <!-- 中古（簡便法）パラメータ -->
      <div id="usedFields" style="display:none; margin-top:6px" class="grid">
        <div>
          <label>初度・製造年月（YYYY-MM）</label>
          <input id="firstUseMonth" type="month" />
        </div>
        <div>
          <label>経過年数（年）※入力時は上記を無効化</label>
          <input id="elapsedYears" type="number" min="0" step="0.1" placeholder="例）3" />
        </div>
      </div>

      <div id="usedEst" class="ok" style="display:none;margin-top:8px"></div>
      <div class="row no-print" style="margin-top:8px">
        <button class="btn" id="run">計算する</button>
        <button id="csvBtn">CSV</button>
        <button id="printBtn">印刷</button>
      </div>
      <div id="msg" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">計算結果</div>
      <div id="summary" class="ok" style="display:none"></div>
      <div class="scroll-x" style="margin-top:10px">
        <table id="tbl" aria-label="償却スケジュール">
          <thead>
            <tr>
              <th>期</th>
              <th>期首帳簿価額</th>
              <th>償却費</th>
              <th>月数</th>
              <th>期末帳簿価額</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">グラフ</div>
      <div class="chart-wrap">
        <div class="legend">
          <div class="legend-item"><span class="swatch" style="background:var(--bar1)"></span><span>期首簿価</span></div>
          <div class="legend-item"><span class="swatch" style="background:var(--bar2)"></span><span>償却限度額</span></div>
        </div>
        <canvas id="chart" aria-label="償却グラフ"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <footer>
        <div class="note">
          ・定率法（200%）は<strong>償却率・改定償却率・保証率</strong>を表に基づき適用し、保証額未達期から改定取得価額×改定償却率で<strong>毎年同額</strong>に切替。<br/>
          ・初年度は入力した月数/12で按分（いわゆる月割）。最終年は<strong>1円残し</strong>で調整（無形は0円）。<br/>
          ・中古（簡便法）は、<strong>法定耐用年数と経過年数</strong>から見積耐用年数を算定（端数切捨て・<strong>最低2年</strong>）。<br/>
          ・プリセット耐用年数は代表例。正式な年数は国税庁「<a class="footlink" href="https://www.nta.go.jp/taxes/shiraberu/taxanswer/shotoku/pdf/2100_01.pdf" target="_blank" rel="noopener">主な耐用年数表</a>」および「<a class="footlink" href="https://www.nta.go.jp/taxes/shiraberu/taxanswer/hojin/5404.htm" target="_blank" rel="noopener">中古資産の耐用年数（No.5404）</a>」をご確認ください。
        </div>
      </footer>
    </div>

    <footer class="site">
      Copyright (c) 2025 <a class="footlink" href="https://www.matsumoto-kaikei.or.jp/">税理士法人松本会計事務所</a> All Rights Reserved. / r13
    </footer>
  </div>

<script>
// ===== 国税庁「償却率等表（200%定率）」の内蔵値 =====
const RATE200 = { 2:{rate:1.000,revised:1.000,guarantee:0.00000}, 3:{rate:0.667,revised:1.000,guarantee:0.11089}, 4:{rate:0.500,revised:1.000,guarantee:0.12499}, 5:{rate:0.400,revised:0.500,guarantee:0.10800}, 6:{rate:0.333,revised:0.334,guarantee:0.09911}, 7:{rate:0.286,revised:0.334,guarantee:0.08680}, 8:{rate:0.250,revised:0.334,guarantee:0.07909}, 9:{rate:0.222,revised:0.250,guarantee:0.07126}, 10:{rate:0.200,revised:0.250,guarantee:0.06552}, 11:{rate:0.182,revised:0.200,guarantee:0.05992}, 12:{rate:0.167,revised:0.200,guarantee:0.05566}, 13:{rate:0.154,revised:0.167,guarantee:0.05180}, 14:{rate:0.143,revised:0.167,guarantee:0.04854}, 15:{rate:0.133,revised:0.143,guarantee:0.04565}, 16:{rate:0.125,revised:0.143,guarantee:0.04294}, 17:{rate:0.118,revised:0.125,guarantee:0.04038}, 18:{rate:0.111,revised:0.112,guarantee:0.03884}, 19:{rate:0.105,revised:0.112,guarantee:0.03693}, 20:{rate:0.100,revised:0.112,guarantee:0.03486}, 21:{rate:0.095,revised:0.100,guarantee:0.03335}, 22:{rate:0.091,revised:0.100,guarantee:0.03182}, 23:{rate:0.087,revised:0.091,guarantee:0.03052}, 24:{rate:0.083,revised:0.084,guarantee:0.02969}, 25:{rate:0.080,revised:0.084,guarantee:0.02841}, 26:{rate:0.077,revised:0.084,guarantee:0.02716}, 27:{rate:0.074,revised:0.077,guarantee:0.02624}, 28:{rate:0.071,revised:0.072,guarantee:0.02568}, 29:{rate:0.069,revised:0.072,guarantee:0.02463}, 30:{rate:0.067,revised:0.072,guarantee:0.02366}, 31:{rate:0.065,revised:0.067,guarantee:0.02286}, 32:{rate:0.063,revised:0.067,guarantee:0.02216}, 33:{rate:0.061,revised:0.063,guarantee:0.02161}, 34:{rate:0.059,revised:0.063,guarantee:0.02097}, 35:{rate:0.057,revised:0.059,guarantee:0.02051}, 36:{rate:0.056,revised:0.059,guarantee:0.01974}, 37:{rate:0.054,revised:0.056,guarantee:0.01950}, 38:{rate:0.053,revised:0.056,guarantee:0.01882}, 39:{rate:0.051,revised:0.053,guarantee:0.01860}, 40:{rate:0.050,revised:0.053,guarantee:0.01791}, 41:{rate:0.049,revised:0.050,guarantee:0.01741}, 42:{rate:0.048,revised:0.050,guarantee:0.01694}, 43:{rate:0.047,revised:0.048,guarantee:0.01664}, 44:{rate:0.045,revised:0.046,guarantee:0.01664}, 45:{rate:0.044,revised:0.046,guarantee:0.01634}, 46:{rate:0.043,revised:0.044,guarantee:0.01601}, 47:{rate:0.043,revised:0.044,guarantee:0.01532}, 48:{rate:0.042,revised:0.044,guarantee:0.01499}, 49:{rate:0.041,revised:0.042,guarantee:0.01475}, 50:{rate:0.040,revised:0.042,guarantee:0.01440}, 51:{rate:0.040,revised:0.050,guarantee:0.01053}, 52:{rate:0.040,revised:0.050,guarantee:0.01036}, 53:{rate:0.039,revised:0.048,guarantee:0.01028}, 54:{rate:0.039,revised:0.048,guarantee:0.01015}, 55:{rate:0.039,revised:0.046,guarantee:0.01007}, 56:{rate:0.038,revised:0.046,guarantee:0.00961}, 57:{rate:0.038,revised:0.046,guarantee:0.00952}, 58:{rate:0.038,revised:0.044,guarantee:0.00945}, 59:{rate:0.037,revised:0.044,guarantee:0.00934}, 60:{rate:0.037,revised:0.044,guarantee:0.00895} };

const ASSET_TYPES = [ {label:'（直接入力）', life:null}, {label:'パソコン（電子計算機・PC）', life:4}, {label:'サーバ（電子計算機のうち）', life:5}, {label:'複合機・プリンタ（事務用機器）', life:5}, {label:'工具・器具備品（一般）', life:5}, {label:'普通乗用車（一般）', life:6}, {label:'軽自動車等', life:4}, {label:'トラック（小型）', life:5}, {label:'事務机・椅子等（什器備品）', life:8}, {label:'建物附属設備（事務所等）', life:15}, {label:'ソフトウェア（自社利用）', life:5} ];

// -------- utils ---------
const fmtYen = n => new Intl.NumberFormat('ja-JP',{maximumFractionDigits:0}).format(Math.round(n||0));
const ceil3 = x => Math.ceil(x*1000)/1000; // 定額法の率：第3位切上げ
const slRate = life => (life===3 ? 0.334 : ceil3(1/Math.max(1, life)));
const parseYen = v => { if(v==null) return NaN; const s=String(v); let out=''; for(let i=0;i<s.length;i++){ const c=s[i]; if((c>='0'&&c<='9')||c==='.'||c==='-'){ out+=c; } } return out.trim()===''?NaN:Number(out); };
const roundByMode=(n,mode)=>{ if(!Number.isFinite(n)) return n; if(mode==='floor') return Math.floor(n); if(mode==='ceil') return Math.ceil(n); return Math.round(n); };
const monthsSchedule=(m1,years)=>{ if(m1>=12) return Array.from({length:years},()=>12); const tail=12-m1; return [m1, ...Array.from({length:years-1},()=>12), tail]; };

// ===== 中古資産（簡便法）ユーティリティ =====
function usedLifeSimplified(baseLife, elapsedYears){ const N = Math.max(1, baseLife|0); const E = Math.max(0, Math.floor(elapsedYears)); let L = 0; if(E >= N){ L = Math.floor(N * 0.2); } else { L = Math.floor((N - E) + E * 0.2); } if(L < 2) L = 2; return L; }
function formatUsedDetail(N, E, L){ if(!(Number.isFinite(N)&&Number.isFinite(E)&&Number.isFinite(L))) return ''; if(E >= N){ const raw = N*0.2; const flo = Math.floor(raw); const minApplied = L>flo ? ' → 下限2年適用' : ''; return `${N}*0.2=${raw.toFixed(1)} → 切捨て${flo}年${minApplied}`; } else { const a = (N-E); const b = 0.2*E; const sum = a + b; const flo = Math.floor(sum); const minApplied = L>flo ? ' → 下限2年適用' : ''; return `(${N}-${E}) + 0.2*${E} = ${a.toFixed(0)} + ${b.toFixed(1)} = ${sum.toFixed(1)} → 切捨て${flo}年${minApplied}`; } }

function buildSchedule({price, life, method, m1Override=null, intangible=false}){
  const rows=[]; 
  const m1 = (Number.isFinite(m1Override) && m1Override>0 && m1Override<=12) ? Math.floor(m1Override) : 12;
  const years = Math.max(1, life|0); 
  const monthsArr = monthsSchedule(m1, years);
  let open = price; let acc=0;
  if(method==='sl'){
    const rate = slRate(years); const annual = price*rate; const salvage = intangible ? 0 : 1;
    for(let i=0;i<monthsArr.length;i++){ const months = monthsArr[i]; let dep = Math.min(annual*(months/12), Math.max(0, open - salvage)); acc += dep; const close = Math.max(salvage, open - dep); rows.push({period:i+1, open, dep, monthsInt:months, acc, close, memo:`定額法（率:${rate.toFixed(3)}${i===monthsArr.length-1? '・最終補完':''}）`}); open = close; }
    return rows;
  }
  if(method==='db200'){
    const rInfo = RATE200[years] || {rate: 2/years, revised: 1/Math.max(1,years), guarantee: 0}; const rate = rInfo.rate; const gRate = rInfo.guarantee; const fixRate = rInfo.revised; const salvage = 1; let switched=false; let revisedBase=null;
    for(let i=0;i<monthsArr.length;i++){
      const months = monthsArr[i]; if(!switched){ const dbAmt = open * rate * (months/12); const gAmt  = price * gRate * (months/12); if(dbAmt < gAmt){ switched = true; revisedBase = open; } }
      let dep=0; let memo=''; if(switched){ dep = revisedBase * fixRate * (months/12); memo = '改定償却率（毎年同額）'; } else { dep = open * rate * (months/12); memo = '定率法（200%）'; }
      if(i===monthsArr.length-1){ dep = Math.min(dep, Math.max(0, open - salvage)); memo += '（最終調整）'; }
      const close = Math.max(salvage, open - dep); const accPrev = rows.length? rows[rows.length-1].acc : 0; acc = accPrev + dep; rows.push({period:i+1, open, dep, monthsInt:months, acc, close, memo}); open = close; if(close<=salvage) break; }
    return rows;
  }
  return rows;
}

function getRoundingMode(){ const on=document.querySelector('#roundingChips .chip-on'); return on? on.dataset.val : 'floor'; }

function toCSV(rows){ const mode=getRoundingMode(); const header = ['期','期首帳簿価額','償却費','月数','期末帳簿価額','備考']; const lines = [header.join(',')]; const salvageDisp = isSoftwareSelected()?0:1; rows.forEach(r=>{ const o=roundByMode(r.open,mode); const d=roundByMode(r.dep,mode); let c=o-d; c = Math.max(salvageDisp, c); lines.push([r.period, o, d, r.monthsInt, c, r.memo].join(',')); }); return new Blob(["﻿" + lines.join('
')], {type:'text/csv;charset=utf-8;'}); }); return new Blob(["\uFEFF" + lines.join('\n')], {type:'text/csv;charset=utf-8;'}); }

function render(rows){
  const mode=getRoundingMode(); const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML = ''; let firstDep = rows[0]?.dep||0; const dispOpen=[]; const dispDep=[];
  const salvageDisp = isSoftwareSelected()?0:1;
  rows.forEach(r=>{ const o=roundByMode(r.open,mode); const d=roundByMode(r.dep,mode); let c=o-d; c = Math.max(salvageDisp, c); dispOpen.push(o); dispDep.push(d); const tr = document.createElement('tr'); tr.innerHTML = `<td style="text-align:left">${r.period}</td>
      <td>¥${fmtYen(o)}</td>
      <td><strong>¥${fmtYen(d)}</strong></td>
      <td>${r.monthsInt}</td>
      <td>¥${fmtYen(c)}</td>
      <td style="text-align:left;color:#334155">${r.memo||''}</td>`; tbody.appendChild(tr); });
  const sum = dispDep.reduce((s,x)=>s+x,0); const box=document.getElementById('summary'); box.textContent=`初年度償却費：¥${fmtYen(roundByMode(firstDep,mode))} ／ 総償却費：¥${fmtYen(sum)}（端数:${mode}）`; box.style.display='block'; lastRows = rows; lastDisp = {open:dispOpen, dep:dispDep}; renderChart(); }</td>
      <td>¥${fmtYen(o)}</td>
      <td><strong>¥${fmtYen(d)}</strong></td>
      <td>${r.monthsInt}</td>
      <td>¥${fmtYen(dispAcc)}</td>
      <td>¥${fmtYen(c)}</td>
      <td style="text-align:left;color:#334155">${r.memo||''}</td>`; tbody.appendChild(tr); });
  const sum = dispDep.reduce((s,x)=>s+x,0); const box=document.getElementById('summary'); box.textContent=`初年度償却費：¥${fmtYen(roundByMode(firstDep,mode))} ／ 総償却費：¥${fmtYen(sum)}（端数:${mode}）`; box.style.display='block'; lastRows = rows; lastDisp = {open:dispOpen, dep:dispDep}; renderChart(); }

// ====== グラフ描画（Canvas 2D） ======
let lastRows = []; let lastDisp={open:[],dep:[]};
function renderChart(){ const canvas = document.getElementById('chart'); if(!canvas || !lastRows || lastRows.length===0) return; const dpr = Math.max(1, window.devicePixelRatio||1); const W = canvas.clientWidth; const H = canvas.clientHeight; canvas.width = Math.floor(W*dpr); canvas.height = Math.floor(H*dpr); const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr); ctx.clearRect(0,0,W,H);
  const padding = {l:50,r:16,t:12,b:40}; const plotW = W - padding.l - padding.r; const plotH = H - padding.t - padding.b; if(plotW<=0||plotH<=0) return;
  const periods = lastRows.length; const maxY = Math.max(...lastDisp.open, ...lastDisp.dep, 1); const x = i => padding.l + (plotW*(i)/(periods-1||1)); const y = v => padding.t + (plotH*(1 - v/maxY));
  // 軸
  ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padding.l, padding.t); ctx.lineTo(padding.l, padding.t+plotH); ctx.lineTo(padding.l+plotW, padding.t+plotH); ctx.stroke();
  // 棒：期首簿価と償却限度額
  const barW = Math.max(2, plotW/(periods*10)); for(let i=0;i<periods;i++){ const cx = x(i); const h1 = plotH * (lastDisp.open[i]/maxY); const h2 = plotH * (lastDisp.dep[i]/maxY); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bar1').trim() || '#bcd7ea'; ctx.fillRect(cx - barW*1.3, padding.t + (plotH - h1), barW, h1); ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bar2').trim() || '#f7c8c8'; ctx.fillRect(cx + barW*0.3, padding.t + (plotH - h2), barW, h2); }
  // X軸ラベル（期）
  ctx.fillStyle='#475569'; ctx.font='11px system-ui, -apple-system, Roboto, Arial'; ctx.textAlign='center'; ctx.textBaseline='top'; for(let i=0;i<periods;i++){ const lx = x(i); ctx.fillText((i+1)+'期', lx, padding.t+plotH+6); }
  // Y目盛
  ctx.textAlign='right'; ctx.textBaseline='middle'; const ticks = 4; for(let t=0;t<=ticks;t++){ const v = maxY * (t/ticks); const yy = y(v); ctx.fillText('¥'+fmtYen(v), padding.l-6, yy); ctx.strokeStyle='#eef2f7'; ctx.beginPath(); ctx.moveTo(padding.l, yy); ctx.lineTo(padding.l+plotW, yy); ctx.stroke(); }
}
window.addEventListener('resize', renderChart);

function isSoftwareSelected(){ const atSel=document.getElementById('assetType'); const v=ASSET_TYPES[Number(atSel.value)]; return !!(v && /ソフトウェア/.test(v.label)); }
function syncMethodChips(){ const val=document.getElementById('method').value; document.querySelectorAll('#methodChips .chip').forEach(btn=>{ btn.classList.toggle('chip-on', btn.dataset.val===val); }); }
function syncSoftwareRules(){ const isSoft = isSoftwareSelected(); const methodSel = document.getElementById('method'); for(const opt of methodSel.options){ if(opt.value==='db200') opt.disabled = isSoft; else opt.disabled=false; } if(isSoft){ methodSel.value='sl'; } const dbChip = document.querySelector('#methodChips .chip[data-val="db200"]'); if(dbChip){ dbChip.classList.toggle('chip-disabled', isSoft); } syncMethodChips(); }

function updateRateInfo(){ const life = Number(document.getElementById('life').value); const el=document.getElementById('rateInfo'); if(!life){ el.textContent=''; return; } const sl=slRate(life); const r200=RATE200[life]?.rate; const rev=RATE200[life]?.revised; const g=RATE200[life]?.guarantee; el.textContent = `償却率：定額 ${sl.toFixed(3)} / 定率 ${r200? r200.toFixed(3):'-'}（改定 ${rev? rev.toFixed(3):'-'}・保証 ${g? g.toFixed(5):'-'}）`; }

function updateEstLife(){ const used = getUsedFlag(); const box = document.getElementById('usedEst'); if(!used){ box.style.display='none'; return; } const baseLife = Number(document.getElementById('life').value); const elapsedRaw = (document.getElementById('elapsedYears').value||'').trim(); if(!baseLife){ box.style.display='none'; return; } if(elapsedRaw===''){ box.style.display='none'; return; } const E=Math.floor(Math.max(0, Number(elapsedRaw))); const L = usedLifeSimplified(baseLife, E); box.textContent = `見積耐用年数：${L}年`; box.style.display='block'; }

function getUsedFlag(){ return document.querySelector('#usedChips .chip-on')?.dataset.val==='used'; }

function go(){
  const price = parseYen(document.getElementById('price').value); const baseLife  = Number(document.getElementById('life').value); const method= document.getElementById('method').value; const usedFlag = getUsedFlag(); const elapsedInputRaw = document.getElementById('elapsedYears').value; const firstUseMonthEl = document.getElementById('firstUseMonth'); const m1Val = Number(document.getElementById('m1').value);
  const msg = document.getElementById('msg'); msg.innerHTML=''; if(!price||isNaN(price)||price<=0){ msg.innerHTML='<div class="warn">取得価額を入力してください。</div>'; return; } if(['sl','db200'].includes(method) && (!baseLife||isNaN(baseLife)||baseLife<=0)){ msg.innerHTML='<div class="warn">耐用年数（年）を入力してください。</div>'; return; } if(!(Number.isFinite(m1Val) && m1Val>=1 && m1Val<=12)){ msg.innerHTML='<div class="warn">初年度月数は1〜12の整数で入力してください。</div>'; return; }
  let effectiveLife = baseLife; let usedNote=''; let EVal = null; if(usedFlag){ const hasElapsed = String(elapsedInputRaw).trim()!=='' && !isNaN(Number(elapsedInputRaw)); if(hasElapsed){ EVal = Math.floor(Math.max(0, Number(elapsedInputRaw))); firstUseMonthEl.value=''; } else { msg.innerHTML='<div class="warn">中古（簡便法）を適用する場合は、「経過年数」を入力してください（詳細設定を廃止したため初度・製造年月のみでは算定できません）。</div>'; return; } effectiveLife = usedLifeSimplified(baseLife, EVal); usedNote = `中古（簡便法）: 元${baseLife}年・経過${EVal}年 → 見積耐用年数 ${effectiveLife}年`; }
  const intangible = isSoftwareSelected(); const methodEff = intangible ? 'sl' : method; const m1Override = Math.floor(m1Val); const rows = buildSchedule({price, life:effectiveLife, method:methodEff, m1Override, intangible}); render(rows); if(usedNote){ const box=document.getElementById('summary'); const prevText = box.textContent; const detail = formatUsedDetail(baseLife, EVal, effectiveLife); box.innerHTML = prevText + ' ／ ' + usedNote + '<br><span class="note">中古（簡便法）計算過程: ' + detail + '</span>'; }
  const blob = toCSV(rows); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='depreciation_schedule.csv'; document.getElementById('csvBtn').onclick=()=>a.click(); }

function init(){
  // 資産タイプ
  const atSel=document.getElementById('assetType'); atSel.innerHTML=''; ASSET_TYPES.forEach((x,i)=>{ const op=document.createElement('option'); op.value=i; op.textContent=x.label + (x.life?`（${x.life}年）`:'' ); atSel.appendChild(op); }); atSel.addEventListener('change',()=>{ const v=ASSET_TYPES[Number(atSel.value)]; if(v&&v.life){ document.getElementById('life').value=v.life; updateRateInfo(); } syncSoftwareRules(); updateEstLife(); });
  // 新規/中古チップ
  document.querySelectorAll('#usedChips .chip').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('#usedChips .chip').forEach(b=>b.classList.remove('chip-on')); btn.classList.add('chip-on'); document.getElementById('usedFields').style.display = getUsedFlag()? '' : 'none'; updateEstLife(); }); });
  // 金額のリアルタイム・カンマ付与
  const priceEl=document.getElementById('price'); let composing=false; const formatNow=()=>{ if(composing) return; const n=parseYen(priceEl.value); if(!isNaN(n)){ priceEl.value=fmtYen(n); try{ priceEl.setSelectionRange(priceEl.value.length, priceEl.value.length);}catch(_){}} }; priceEl.addEventListener('compositionstart', ()=> composing=true); priceEl.addEventListener('compositionend', ()=> { composing=false; formatNow(); }); priceEl.addEventListener('input', formatNow); priceEl.addEventListener('blur', formatNow);
  // 中古 相互排他
  const elapsed=document.getElementById('elapsedYears'); const first=document.getElementById('firstUseMonth'); elapsed.addEventListener('input', ()=>{ if(elapsed.value.trim()!==''){ first.value=''; } updateEstLife(); }); first.addEventListener('input', ()=>{ if(first.value.trim()!==''){ elapsed.value=''; } updateEstLife(); });
  // 依存入力
  document.getElementById('life').addEventListener('input', ()=>{ updateRateInfo(); updateEstLife(); }); updateRateInfo();
  // 方法チップ
  document.querySelectorAll('#methodChips .chip').forEach(btn=>{ btn.addEventListener('click', ()=>{ const val=btn.dataset.val; if(isSoftwareSelected() && val==='db200') return; document.getElementById('method').value = val; syncMethodChips(); }); }); syncSoftwareRules();
  // 端数処理チップ
  document.querySelectorAll('#roundingChips .chip').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('#roundingChips .chip').forEach(b=>b.classList.remove('chip-on')); btn.classList.add('chip-on'); if(lastRows.length) render(lastRows); }); });
  // ボタン
  document.getElementById('run').addEventListener('click', go); document.getElementById('printBtn').addEventListener('click', ()=> window.print());
}

document.addEventListener('DOMContentLoaded', init);

// ========= 自己テスト（詳細設定廃止に合わせて調整） =========
(function selfTest(){ try{ const rowsSL = buildSchedule({price:300000, life:5, method:'sl', m1Override:7, intangible:false}); const depsSL = rowsSL.map(r=>Math.round(r.dep)); const okSL = depsSL.length===6 && depsSL[0]===35000 && depsSL[1]===60000 && depsSL[2]===60000 && depsSL[3]===60000 && depsSL[4]===60000 && depsSL[5]===24999 && rowsSL[5].monthsInt===5; if(!okSL) console.warn('SelfTest: SL pattern mismatch', depsSL, rowsSL.map(r=>r.monthsInt)); const rowsDB = buildSchedule({price:300000, life:5, method:'db200', m1Override:7, intangible:false}); const lastRow = rowsDB[rowsDB.length-1]; if(lastRow.monthsInt!==5 || Math.round(lastRow.close)!==1){ console.warn('SelfTest: DB200 last row expected months 5 and close 1, got', lastRow.monthsInt, lastRow.close); } const rowsSoft = buildSchedule({price:120000, life:5, method:'sl', m1Override:7, intangible:true}); const lastClose = rowsSoft[rowsSoft.length-1].close; if(lastClose!==0) console.warn('SelfTest: intangible last close expected 0, got', lastClose); if(RATE200[5].rate!==0.400) console.warn('SelfTest: RATE200[5].rate expected 0.400'); const L1 = usedLifeSimplified(6,4); if(L1!==2) console.warn('SelfTest: usedLifeSimplified 6/4 expected 2, got', L1); const L2 = usedLifeSimplified(5,7); if(L2!==2) console.warn('SelfTest: usedLifeSimplified 5/7 expected 2, got', L2); if(slRate(3)!==0.334) console.warn('SelfTest: slRate(3) expected 0.334, got', slRate(3)); if(parseYen('1,200,000')!==1200000) console.warn('SelfTest: parseYen comma fail'); const b = toCSV([{period:1,open:100,dep:100,monthsInt:12,acc:100,close:1,memo:'t'}]); if(!(b && b.size>0)) console.warn('SelfTest: CSV blob NG'); }catch(err){ console.error('SelfTest exception', err); }})();
</script>
</body>
</html>
